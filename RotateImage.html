<html>
	<head>
		<title>Rotate Image</title>
		<script>

			var img = new Image();

			const loadImg = () => {
				/*
				*Load empty canvas
				*/
				img.src='';
				var canvas = document.getElementById('canvasa');
				var ctx = canvas.getContext('2d');
//				img.crossOrigin = "Anonymous";
				img.onload = function() {
				  if (img.src!=='') {
					canvas.width = img.width;
					canvas.height = img.height;
				  }
 				  ctx.drawImage(img, 0, 0);
				  img.style.display = 'none';
				};
			}
			const rotateImg = () => {
				/*
				* Rotate the image according to angle inbox degree
				*/
				let canvas = document.getElementById('canvasa');
				const angleDec = document.getElementById('angle').value;
				let ctx = canvas.getContext('2d');
				var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

				let data = imgData.data;
				const angle = angleDec * Math.PI / 180;
				
				let width = imgData.width;
				let height = imgData.height;
				let cData;
				let newWidth = width;
				let newHeight = height;
				
				/*
				* Calculate the Size of a Rotated Image
				* For 180 and 360 degrees, size is same
				* For 90 and 270 degrees, width and height are reversed
				* For <90 degrees, Use new-width=w x cos@ + h x sin@, new-height=w x sin@ + h x cos@
				* For >90 degrees, Use new-width=h x cos@ + w x sin@, new-height=h x sin@ + w x cos@
				* Reference: https://iiif.io/api/annex/notes/rotation/
				*/				
				if (angleDec%180===0) {
					cData = new Uint8ClampedArray(width*height*4);
				}else if (angleDec%90===0) {
					newWidth=height;
					newHeight=width;
					cData = new Uint8ClampedArray(newWidth*newHeight*4);
				}else if (angleDec<90) {
					newWidth = Math.ceil(width * Math.cos(angle) + height * Math.sin(angle))+4;
					newHeight = Math.ceil(width * Math.sin(angle) + height * Math.cos(angle))+4;
					cData = new Uint8ClampedArray(newWidth*newHeight*4);
				} else if (angleDec%360>90) {
					const rAngle=(angleDec%360-90) * Math.PI / 180;
					newWidth = Math.ceil(height * Math.cos(angle) + width * Math.sin(angle))+4;
					newHeight = Math.ceil(height * Math.sin(angle) + width * Math.cos(angle))+4;
					cData = new Uint8ClampedArray(newWidth*newHeight*4);
				}
				/*
				*To rotate, POST call from server(In this example node.js server)
				*/
				fetch("/rotate",{
					json: {limit: '50mb', extended: true},
					urlencoded: {limit: '50mb', extended: true},
					headers: {
					  'Accept': 'application/json',
					  'Content-Type': 'application/json'
					},
					method: "POST",
					body: JSON.stringify({
					  imagedata: imgData.data,
					  width:imgData.width,
					  height:imgData.height,
					  angle: angleDec
					})
				})
				.then(function(res){
					return res.json(); 
				}).then(function(obj) {
					//Get rotated imagedata response and redraw the canvas
					imgData = new ImageData(newWidth,newHeight);
					for (let i = 0; i < newWidth*newHeight*4; i++) {
						imgData.data[i] = obj.data[i];
					}
					canvas.width = imgData.width;
					canvas.height = imgData.height;
					ctx.putImageData(imgData, 0, 0);
				}).catch(function(res){
					console.log("Error"); 
				});	
			}			
		</script>
	</head>
	<body onload="loadImg()">
		<canvas id="canvasa" width=100 height=100 style="float:left"></canvas>
		<div id="color">
		<form id="uploadForm" action="fileupload" method="post" enctype="multipart/form-data">
		  <input type="file" name="filetoupload" onchange="document.getElementById('uploadForm').submit()"><br>
		  <input type="number" id="angle" min="0" max="360"/>
		  <input type="button" value="Rotate" onClick='rotateImg()'/>
		</form>
		</div>
	</body>
</html>